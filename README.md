# starkgate-frontend

This is a fork of Starkgate to enable the transfer of ZEND. Originally, the code written for Stargate only supports the [legacy bridge](https://github.com/starknet-io/starkgate-contracts/blob/v2.0/src/solidity/LegacyBridge.sol). This fork modifies a little bit of code to support [StarkTokenBridge](https://github.com/starknet-io/starkgate-contracts/blob/v2.0/src/solidity/StarknetTokenBridge.sol), which is a generic bridge that can support multiple tokens in contrast to the legacy bridge that can only support a token per bridge.

## Limitations

Currently, only L1 to L2 transfer is supported. The reason L2 to L1 transfer isn't supported is as follows:

There are two ways to transfer an asset from L2 to L1.

1. Invoke [`initiate_token_withdraw`](https://github.com/starknet-io/starkgate-contracts/blob/d62a255307d2f3de65665f18316766a2c69ead78/src/cairo/token_bridge.cairo#L494), and wait for the off-chain indexer that can be queried at https://starkgate.starknet.io/transfer-log/api/get_pending_withdrawals to pick up the call to [`initiate_token_withdraw`](https://github.com/starknet-io/starkgate-contracts/blob/d62a255307d2f3de65665f18316766a2c69ead78/src/cairo/token_bridge.cairo#L494). But even though I called [`initiate_token_withdraw`](https://github.com/starknet-io/starkgate-contracts/blob/d62a255307d2f3de65665f18316766a2c69ead78/src/cairo/token_bridge.cairo#L494) at https://starkscan.co/tx/0x01b477020119170861023ed5e4623bb3f34348401f11c66fda025579c15b7a63, with `l1_recipient` of 0x77bfe2e6b987e55f482e503ce48df21c889d32ae, the indexer won't just pick it up and still return an empty list when I call https://starkgate.starknet.io/transfer-log/api/get_pending_withdrawals?l1address=0x77bFE2E6B987E55F482E503Ce48Df21c889d32aE. There is no cors error, but just an empty list. It seems that StarkGate's indexer only supports legacy bridges and not [`StarknetTokenBridge`](https://github.com/starknet-io/starkgate-contracts/blob/v2.0/src/solidity/StarknetTokenBridge.sol) (AKA multibridge). Basically this one does not work and their indexer doesn't seem to be open source. To solve this problem, we will need to either contact Starknet to ask for the multibridge support or build the indexer ourselves.
2. Use the [relayer](https://starkscan.co/contract/0x06e02b62e101b44382d030d7aee5528bf65eed13d3b2d5da3dfa883a2e1ce5f7) written by SpaceShard by paying a small fee in ETH. This is the "Use the automatic withdrawal service by SpaceShard" option on https://starkgate.starknet.io/. Basically they do some magic behind and makes the withdrawal happen for you automatically once you call [`initiate_token_withdraw`](https://github.com/starknet-io/starkgate-contracts/blob/d62a255307d2f3de65665f18316766a2c69ead78/src/cairo/token_bridge.cairo#L494). This also doesn't support [`StarknetTokenBridge`](https://github.com/starknet-io/starkgate-contracts/blob/v2.0/src/solidity/StarknetTokenBridge.sol). It needs to calculate gas cost by calling https://starkgate.spaceshard.io/v1/gas-cost/0x0616757a151c21f9be8775098d591c2807316d992bbc3bb1a5c1821630589256/{epoch_timestamp} like https://starkgate.spaceshard.io/v1/gas-cost/0x0616757a151c21f9be8775098d591c2807316d992bbc3bb1a5c1821630589256/1710377423 but it just returns `{"statusCode":400,"message":"Token not handled","error":"Bad Request"}`. It works for other legacy token bridges like
   https://starkgate.spaceshard.io/v1/gas-cost/0x073314940630fd6dcda0d772d4c972c4e0a9946bef9dabf4ef84eda8ef542b82/1710379858. So most definitely they would need to add support for multibridge. I also tried skipping the gas cost step by injecting some gas cost value by using another legacy token bridge's address and sending the transaction right away at https://starkscan.co/tx/0x043834fb661ef70047e76f21042c21bd8c5204011cc978c17d5b5333e4a5d546 (btw, the latest changes to get L2 -> L1 transfer working are at https://github.com/zkLend/starkgate-frontend/tree/l2-to-l1-transfer), but the transaction doesn't get picked up by the [relayer](https://starkscan.co/contract/0x06e02b62e101b44382d030d7aee5528bf65eed13d3b2d5da3dfa883a2e1ce5f7). So it is very likely that the relayer doesn't support [`StarknetTokenBridge`](https://github.com/starknet-io/starkgate-contracts/blob/v2.0/src/solidity/StarknetTokenBridge.sol) too. To solve this problem, we will need to contact SpaceShard to update the relayer and their own indexer that watches the transactions and events.

## Development

Currently, Goerli is almost near the end of its life, and most RPC nodes and explorers are not really keen on maintaining the sync with it. However, very unfortunately Starkgate hasn't deployed [`StarknetTokenBridge`](https://github.com/starknet-io/starkgate-contracts/blob/v2.0/src/solidity/StarknetTokenBridge.sol) on Sepolia, so Goerli needs to be used.

You can check the list of addresses at https://github.com/starknet-io/starknet-addresses/blob/master/bridged_tokens/sepolia.json and wait for [`MultiBridge`](https://github.com/starknet-io/starknet-addresses/blob/1f3988f76dae9196e33d8a7d0b2623b783bf8ecc/bridged_tokens/goerli.json#L119) to be added to `sepolia.json`.

To faciliate testing, an ERC20 `MockZend` contract was deployed to [0x7b1bf875977e4124dc781153bd6393c8e1c22739](https://goerli.etherscan.io/address/0x7b1bf875977e4124dc781153bd6393c8e1c22739#code) on Goerli and `enrollTokenBridge` was called to add the token to [`StarknetTokenBridge`](https://github.com/starknet-io/starkgate-contracts/blob/v2.0/src/solidity/StarknetTokenBridge.sol). You can verify that `MockZend` has been added by calling `get_l2_token(0x7b1bF875977E4124dc781153BD6393c8e1C22739)` at https://testnet.starkscan.co/contract/0x0627582c893c1506750d28a40a2e781031554c16544ff7b390c117978bc03de7#read-write-contract, which should return `0x501ac4f2b0e06a088fc71e009ae54bc3c89ffca7b24b7e27a7966449d88ed6b` which is the L2 token address for `MockZend`.

However, even the sync between Goerli Starknet and Goerli Ethereum is extremely slow, and the bridge transaction will at least take several hours to see the result on the other side.

Therefore, zkLend team has decided to test directly on mainnet, which turns out to be the easiest way. **Testing on Goerli is not recommended**. But if you need testing on Goerli, you can mint `MockZend` freely at https://goerli.etherscan.io/address/0x7b1bf875977e4124dc781153bd6393c8e1c22739#writeContract by calling `freeMint` or `freeMintWithAmount`. Optimistically, we will just wait for Starknet team to deploy the bridge contract on Sepolia.
